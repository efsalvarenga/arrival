---
title: "Levels"
output:
  md_document:
    variant: markdown_github
date: "2023-03-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(yaml)
```

## Table of levels

```{r levelTbl}

intendedSessionsMult <- 1.4

levelTbl <- data.frame(xp = c(0, 300, 900, 2700, 6500, 14000, 23000, 34000,
                              48000, 64000, 85000, 100000, 120000, 140000,
                              165000, 195000, 225000, 265000, 305000, 355000),
                       level = 1:20,
                       tier = c(rep(1, 4), rep(2, 6), rep(3, 6), rep(4, 4))) %>% 
  mutate(rank = as.integer(round((level - 1) / 3)),
         xpPerChap = (200 * rank^2 + 500 * level - 500) / intendedSessionsMult,
         xpPerChap = as.integer(pmax(xpPerChap, 200)),
         xpPerChap = round(xpPerChap / 10) * 10,
         xpPerChapL = dplyr::lag(xpPerChap, default = 200),
         xpPerChapR = dplyr::lead(xpPerChap, default = 11930),
         xpPerChapL = (xpPerChap + xpPerChapL) / 2,
         xpPerChapL = round((xpPerChap + xpPerChapL) / 20) * 10,
         xpPerChapR = (xpPerChap + xpPerChapR) / 2,
         xpPerChapR = round((xpPerChap + xpPerChapR) / 20) * 10,
         xpPerChapBound = paste0('[', xpPerChapL, ', ', xpPerChapR, ']'),
         lvlUpXp = xp - lag(xp, default = first(xp)),
         lvlUpXp = lead(lvlUpXp, default = last(lvlUpXp)),
         chapToLevel = round(lvlUpXp / xpPerChap, 1),
         DCmin = as.integer(12 + rank),
         CRsolo = rank * 3 + tier + 1,
         CR1vs1 = round(CRsolo / 3 + (level - 8) * tier / 20, 1),
         CR2vs1 = round(CR1vs1 * 0.6 * 2, 1),
         CR4vs1 = round(CR1vs1 * 0.4 * 4, 1),
         consMgcItmQtd = c(rep(2, 4), 3, rep(2, 3), 1, 1, 2, 2,
                           rep(c(2, 2, 1), 2), 1, 2),
         consMgcItmTbl = c(rep('A', 5), rep('B', 5), rep('C', 5),
                           rep('D', 4), rep('E', 1)),
         permMgcItmTbl = c(rep('--', 2), rep(c(rep('F', 2), '--'), 2),
                           rep(c(rep('G', 2), '--'), 2), rep('H', 2),
                           '--', rep('Lgdry', 2), '--')) %>%
  group_by(tier) %>%
  mutate(tierSum = pmax(1, 1.4 * cumsum(tier) / min(tier) - 0.5),
         hoardTreasure = round(tierSum / chapToLevel,  1)) %>%
  ungroup() %>%
  select(-tierSum, -lvlUpXp, -xpPerChapL, -xpPerChapR)

knitr::kable(levelTbl, format = 'pipe')
```

Sessions per tier and rank of play.

```{r levelTblPerTier}
levelTblPerTier <- levelTbl %>%
  group_by(tier) %>%
  summarise(totSessions = round(sum(chapToLevel))) %>%
  mutate(ratioCampaign = round(totSessions / sum(totSessions), 2))

knitr::kable(levelTblPerTier, format = 'pipe')
```

```{r levelTblPerRank}
levelTblPerRank <- levelTbl %>%
  group_by(rank) %>%
  summarise(totSessions = round(sum(chapToLevel))) %>%
  mutate(ratioCampaign = round(totSessions / sum(totSessions), 2))

knitr::kable(levelTblPerRank, format = 'pipe')
```

Magic items number aligned with DMG stats (evaluated [here](https://www.enworld.org/threads/analysis-of-typical-magic-item-distribution.395770/)).

For a party of 5, the goal is:

**Permanent**
- F: 10-15 between levels 3 and 7
- G: 10-15 between levels 9 and 13
- H: 5-8 between levels 15 and 16
- Lgdry: 5-8 between levels 18 and 19

**Consumable**
- A: 25-35 between levels 1 and 5
- B: 25-35 between levels 6 and 10
- C: 25-35 between levels 11 and 15
- D: 20-30 between levels 16 and 19
- E: 5-8 in level 20

```{r levelTblMagicItems}
levelTblMagicItemsP <- levelTbl %>%
  group_by(permMgcItmTbl) %>%
  summarise(totItems = sum(chapToLevel)) %>%
  filter(permMgcItmTbl != '--')

levelTblMagicItemsC <- levelTbl %>%
  mutate(totItems = consMgcItmQtd * chapToLevel) %>%
  group_by(consMgcItmTbl) %>%
  summarise(totItems = sum(totItems))


knitr::kable(levelTblMagicItemsP, format = 'pipe')
knitr::kable(levelTblMagicItemsC, format = 'pipe')
```


## PCs current development

Current PCs level and estimated deadly CR (lazy benchmark).

```{r currentPCs}
pcs <- data.frame(name = c('Miraak', 'Guilf', 'Dolman', 'Kethra', 'Amyria'),
                  level = c(5,        5,       5,        5,        4))

knitr::kable(pcs, format = 'pipe')

```

Current party average level, tier, estimated CR, minimal DC for checks, treasures and 

```{r currentParty}
currentParty <- data.frame(level = as.integer(round(mean(pcs$level))),
                           members = nrow(pcs)) %>%
  left_join(levelTbl, by = 'level') %>%
  select(-xp, - chapToLevel) %>%
  mutate(tier = as.integer(tier),
         CRsolo = as.integer(CRsolo + members - 4),
         CR1vs1 = as.integer(round(CR1vs1 * members)),
         CR2vs1 = as.integer(round(CR2vs1 * members)),
         CR4vs1 = as.integer(round(CR4vs1 * members)),
         cr_gauges = paste0('[', CRsolo, ', ', CR1vs1, ', ',
                            CR2vs1, ', ', CR4vs1, ']'),
         xpPerChap = as.integer(xpPerChap),
         consMgcItmTbl = paste0(consMgcItmQtd, 'x', consMgcItmTbl)) %>%
  select(-CRsolo, -CR1vs1, -CR2vs1, -CR4vs1, -consMgcItmQtd) %>%
  rename(party_level = level, party_tier = tier, party_rank = rank,
         xp = xpPerChap, xp_bounds = xpPerChapBound, dc_min = DCmin) %>%
  relocate(cr_gauges, .after = dc_min)

cat(as.yaml(currentParty))
```
